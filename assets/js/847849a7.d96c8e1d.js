"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[299],{8117:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var a=n(4848),i=n(8453);const s={},o="Pool OffChain Data",r={id:"Guides/pool-offchain-data",title:"Pool OffChain Data",description:"(as of 13.2.0.0 Offline was renamed to OffChain)_",source:"@site/docs/Guides/pool-offchain-data.md",sourceDirName:"Guides",slug:"/Guides/pool-offchain-data",permalink:"/cardano-db-sync/Guides/pool-offchain-data",draft:!1,unlisted:!1,editUrl:"https://github.com/sgillespie/cardano-db-sync/tree/docs/docusaurus/doc/docusaurus/docs/Guides/pool-offchain-data.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Interesting SQL queries",permalink:"/cardano-db-sync/Guides/interesting-queries"},next:{title:"Schema Management",permalink:"/cardano-db-sync/Guides/schema-management"}},c={},d=[{value:"http-get-json-metadata",id:"http-get-json-metadata",level:3}];function h(e){const t={code:"code",em:"em",h1:"h1",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.h1,{id:"pool-offchain-data",children:"Pool OffChain Data"}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.em,{children:"(as of 13.2.0.0 Offline was renamed to OffChain)"}),"_"]}),"\n",(0,a.jsx)(t.p,{children:"When a stake pool is registered, a transaction is added to the chain containing the URL of the\npool's offchain data."}),"\n",(0,a.jsxs)(t.p,{children:["The data in the transaction specifying the location of the offchain data is inserted into the\n",(0,a.jsx)(t.code,{children:"PoolMetadataRef"})," table. ",(0,a.jsx)(t.code,{children:"db-sync"})," then fetches the specified data and inserts it into the\n",(0,a.jsx)(t.code,{children:"OffChainPoolData"})," table."]}),"\n",(0,a.jsx)(t.p,{children:"The basic operation is a follows:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["When the pool registration is found in a tx it is inserted into the ",(0,a.jsx)(t.code,{children:"PoolMetadataRef"})," table."]}),"\n",(0,a.jsxs)(t.li,{children:["Another thread periodically queries the database for ",(0,a.jsx)(t.code,{children:"PoolMetadataRef"})," entries which have either\nnot been retrieved or have errored and tries to fetch the data."]}),"\n",(0,a.jsxs)(t.li,{children:["If the new fetch is successful, the result goes in the ",(0,a.jsx)(t.code,{children:"OffChainPoolData"})," table."]}),"\n",(0,a.jsxs)(t.li,{children:["If the fetch fails, an error is recorded in ",(0,a.jsx)(t.code,{children:"PoolOffChainFetchError table"})," to be retried later."]}),"\n",(0,a.jsx)(t.li,{children:"The retries on fetch fail start at 60 seconds and are progressively longer and eventually plateau\nat a retry every 24 hours."}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"http-get-json-metadata",children:"http-get-json-metadata"}),"\n",(0,a.jsxs)(t.p,{children:["This is an testing/debugging program. It uses ",(0,a.jsx)(t.em,{children:"the same code"})," to fetch the offchain metadata as\n",(0,a.jsx)(t.code,{children:"cardano-db-sync"}),". It is not code copy, this application calls the function in ",(0,a.jsx)(t.code,{children:"db-sync"})," that does\nthe actual fetch (the function is named ",(0,a.jsx)(t.code,{children:"httpGetOffChainData"}),")."]}),"\n",(0,a.jsx)(t.p,{children:'On success, this program will print "Success" and then print the retrieved JSON.'}),"\n",(0,a.jsx)(t.p,{children:"On failure, the error message is printed."}),"\n",(0,a.jsxs)(t.p,{children:["The program can be run from the ",(0,a.jsx)(t.code,{children:"cardano-db-sync"})," git checkout as:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:"> cabal run -- http-get-json-metadata <url>\n"})}),"\n",(0,a.jsx)(t.p,{children:"If you also want to check the JSON meta data hash, the program can be run as:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:"> cabal run -- http-get-json-metadata <url> <hash>\n"})}),"\n",(0,a.jsx)(t.p,{children:"where the hash is specified as a string of hexadecimal digits."}),"\n",(0,a.jsx)(t.p,{children:"If you don't know the hash, you can provide an empty string for this field and the program will\nprint the execpted hash in the error message. Eg:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:'> cabal run -- http-get-json-metadata https://git.io/Jt01O ""\nUp to date\nHash mismatch from when fetching metadata from https://git.io/Jt01O. Expected  but got\n   54796c0c86228b9c86a1982e76441b293d01b7a9cd1309d43ae95123a8ad8933.\n'})}),"\n",(0,a.jsx)(t.p,{children:"You can then run the program again with the provided hash:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:'> cabal run -- http-get-json-metadata https://git.io/Jt01O 54796c0c86228b9c86a1982e76441b293d01b7a9cd1309d43ae95123a8ad8933\nUp to date\nSuccess\n{"description":"Guaranteed lifetime 1% staking pool. Proceeds go toward crypto education.",\n"homepage":"https://cardano.afterschoollabs.io","name":"After School Labs","ticker":"ASLAB"}\n'})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.strong,{children:"Note:"}),' Up until now (2022/09/30) the code to fetch the pool offchain metadata did not check the\n"content-type" field in the response headers, but now it does. The rules for how this field is\nhandled is as follows:']}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"application/json"}),": This is the expected value."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"text/plain"}),": Currently accepted."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"application/octet-stream"}),": Currently accepted."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"binary/octet-stream"}),": Currently accepted."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"application/binary"}),": Currently accepted."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.code,{children:"text/html"}),": Currently accepted only if it might be JSON (ie first non-whitespace character of\nbody is ",(0,a.jsx)(t.code,{children:"{"}),"). Some time after 2024/01/01 this will no longer be accepted.\nthe future"]}),"\n",(0,a.jsx)(t.li,{children:"missing content-type header: Currently accepted, but some time after 2024/01/01 this will no\nlonger be accepted."}),"\n",(0,a.jsx)(t.li,{children:"all others: Rejected."}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["Also note that extra text in the ",(0,a.jsx)(t.code,{children:"comtemt-type"})," header fieled (eg ",(0,a.jsx)(t.code,{children:"charset=utf-8"}),") is ignored."]})]})}function l(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>r});var a=n(6540);const i={},s=a.createContext(i);function o(e){const t=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);