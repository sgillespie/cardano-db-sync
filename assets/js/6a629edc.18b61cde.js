"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[929],{1305:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>r,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>h});var t=n(4848),a=n(8453);const o={sidebar_position:4},r="State Snapshots",i={id:"state-snapshot",title:"State Snapshots",description:"As the size of the blockchain itself and the number of transactions and other data on the chain",source:"@site/docs/state-snapshot.md",sourceDirName:".",slug:"/state-snapshot",permalink:"/cardano-db-sync/state-snapshot",draft:!1,unlisted:!1,editUrl:"https://github.com/sgillespie/cardano-db-sync/tree/docs/docusaurus/doc/docusaurus/docs/state-snapshot.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Running",permalink:"/cardano-db-sync/running"},next:{title:"Schema",permalink:"/cardano-db-sync/schema"}},c={},h=[{value:"Things to note:",id:"things-to-note",level:2}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"state-snapshots",children:"State Snapshots"}),"\n",(0,t.jsx)(s.p,{children:"As the size of the blockchain itself and the number of transactions and other data on the chain\nincreases, the time required to sync the full chain increases. At epoch 266 it was about 18 hours.\nThe other issue is that most major upgrades also update the database schema meaning the database\nneeds to be synced from scatch."}),"\n",(0,t.jsxs)(s.p,{children:["To overcome these issues, we are providing a ",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," state snapshot, which should\ndrastically reduce the time required to get ",(0,t.jsx)(s.code,{children:"db-sync"})," back up and running after the database is\ndropped and recreated. This snapshot is compatible with both ",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," and\n",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," with --no-epoch-table (which doesn't maintain the extra ",(0,t.jsx)(s.code,{children:"epoch"})," table)."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Note:"})," It is ",(0,t.jsx)(s.strong,{children:"not"})," possible to create a snapshot from one version of the database schema and\nrestore it so it can be used with a ",(0,t.jsx)(s.code,{children:"db-sync"})," that uses another version of the schema."]}),"\n",(0,t.jsxs)(s.p,{children:["All of the following assumes that the executable ",(0,t.jsx)(s.code,{children:"cardano-db-tool"})," and the script\n",(0,t.jsx)(s.code,{children:"postgresql-setup.sh"})," is available on the machine where the snapshot is being created or restored."]}),"\n",(0,t.jsx)(s.p,{children:"Currently (at epoch 269), creating a snapshot takes about 15 minutes and restoring one takes about\n45 minutes."}),"\n",(0,t.jsx)(s.h2,{id:"things-to-note",children:"Things to note:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Snapshots (because they depend on the database schema) are not portable across ",(0,t.jsx)(s.code,{children:"db-sync"})," versions."]}),"\n",(0,t.jsxs)(s.li,{children:["Snapshots (because they include a snapshot of the ledger state) are not portable across CPU\narchitectures (ie it is not possible to create a snapshot on ",(0,t.jsx)(s.code,{children:"x86_64"})," and expect it to work\ncorrectly on say ",(0,t.jsx)(s.code,{children:"arm64"}),")."]}),"\n",(0,t.jsxs)(s.li,{children:["Creating and restoring snapshots requires significant amounts of free disk space (at epoch 269\nit required about 10G). If there is insufficient disk space, ",(0,t.jsx)(s.code,{children:"gzip"})," can give some odd error\nmessages."]}),"\n",(0,t.jsxs)(s.li,{children:["node tip should be ahead of the snapshot point during restoration otherwise ",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," will\nroll back to genesis"]}),"\n"]}),"\n",(0,t.jsx)(s.h1,{id:"creating-a-snapshot",children:"Creating a Snapshot"}),"\n",(0,t.jsxs)(s.p,{children:["To create a snapshot, the ",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," executable should be stopped. Taking a snapshot is\nthen a two step process:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"PGPASSFILE=config/pgpass-mainnet cardano-db-tool prepare-snapshot --state-dir ledger-state/mainnet/\n"})}),"\n",(0,t.jsx)(s.p,{children:"which will then print out the command (combining the database schema version with the block number\nin the database with the slot number used by the ledger state and the ) required to generated the snapshot:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"PGPASSFILE=config/pgpass-mainnet scripts/postgresql-setup.sh --create-snapshot \\\n    db-sync-snapshot-schema-9-block-5796064-x86_64 ledger-state/mainnet/31021676-f3873e4bec.lstate\n"})}),"\n",(0,t.jsx)(s.h1,{id:"restoring-from-a-snapshot",children:"Restoring from a Snapshot"}),"\n",(0,t.jsx)(s.p,{children:"Restoring the state from a snapsot will drop the current database, recreate the tables and then\npopulate them. It can be done as simply as:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"PGPASSFILE=config/pgpass-mainnet scripts/postgresql-setup.sh --restore-snapshot \\\n\tdb-sync-snapshot-schema-9-block-5796064-x86_64 ledger-state/mainnet\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Once the script has completed successfully, ",(0,t.jsx)(s.code,{children:"db-sync"})," can be restarted and it should continue\nsyncing from the block number listed in the state snapshot file name."]}),"\n",(0,t.jsx)(s.h1,{id:"mainnet-snapshots-location",children:"Mainnet Snapshots Location"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"Mainnet"})," snapshots can be found ",(0,t.jsx)(s.a,{href:"https://update-cardano-mainnet.iohk.io/cardano-db-sync/index.html#",children:"here"}),".\nThey are also linked from the ",(0,t.jsx)(s.code,{children:"cardano-db-sync"})," ",(0,t.jsx)(s.a,{href:"https://github.com/IntersectMBO/cardano-db-sync/releases",children:"releases page"})]})]})}function l(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>i});var t=n(6540);const a={},o=t.createContext(a);function r(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);